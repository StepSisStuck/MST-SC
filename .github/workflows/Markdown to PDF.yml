name: Convert Markdown to PDF

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Install Dependencies
      run: sudo apt-get update && sudo apt-get install -y pandoc texlive texlive-xetex

    - name: Convert Markdown to PDF
      run: |
        find . -type f -name "*.md" | while read -r mdfile; do
          pdfdir="pdf/$(dirname "$mdfile")"
          mkdir -p "$pdfdir"
          pdffile="${pdfdir}/$(basename "${mdfile%.md}.pdf")"
          pandoc "$mdfile" -o "$pdffile"
        done

    - name: Commit and Push PDFs
      if: success() && github.event_name == 'push'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add pdf/
        git commit -m "Convert Markdown files to PDF"
        git push

    - name: Upload PDFs as Artifact
      uses: actions/upload-artifact@v3
      with:
        name: converted-pdf-files
        path: pdf/
        retention-days: 7 # Adjust as needed

    - name: Add Link to Summary
      run: echo "::notice::ðŸ“Ž [Click here to download the PDF files artifact](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
